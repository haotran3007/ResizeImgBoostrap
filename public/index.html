<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Resize Image Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Firebase (giữ nguyên như bạn có) -->
  <script defer src="/__/firebase/12.8.0/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-database-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-firestore-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-functions-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-messaging-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-storage-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-analytics-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-remote-config-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-remote-config-compat.js"></script>
  <script defer src="/__/firebase/12.8.0/firebase-performance-compat.js"></script>
  <script defer src="/__/firebase/init.js?useEmulator=true"></script>

  <link rel="stylesheet" href="./styles.css">
  <script src="./script.js"></script>
</head>

<body class="bg-light">
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-lg-10">

        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="mb-3">Resize / Compress Images</h3>

            <div class="alert alert-info mb-3">
              <div class="fw-semibold mb-1">Lưu vào đúng thư mục (theo lựa chọn của bạn):</div>
              <div>
                Chrome/Edge: chọn thư mục một lần → ảnh sẽ tự động lưu vào thư mục đó (giữ nguyên tên tệp)<br>
                Trình duyệt khác: tải xuống theo cơ chế thông thường (trình duyệt quyết định vị trí lưu)
              </div>
            </div>

            <div class="card border-0 shadow-sm mb-3 guide-card">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                  <h5 class="mb-0">Hướng dẫn sử dụng</h5>
                  <span class="badge rounded-pill text-bg-light guide-badge">Quy trình thao tác</span>
                </div>

                <div class="table-responsive mt-3">
                  <table class="table table-sm align-middle mb-0 guide-table">
                    <thead>
                      <tr>
                        <th style="width:70px;">Bước</th>
                        <th style="width:240px;">Thao tác</th>
                        <th>Nội dung</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="fw-semibold">1</td>
                        <td>Chọn tệp hình ảnh</td>
                        <td>Nhấn <span class="fw-semibold">Chọn ảnh</span> để chọn một hoặc nhiều hình ảnh cần xử lý
                        </td>
                      </tr>
                      <tr>
                        <td class="fw-semibold">2</td>
                        <td>Thiết lập thông số</td>
                        <td>
                          Cấu hình <span class="fw-semibold">Dung lượng mục tiêu (KB)</span>,
                          <span class="fw-semibold">Định dạng đầu ra</span>,
                          <span class="fw-semibold">Chiều rộng tối đa</span> và
                          <span class="fw-semibold">Tỷ lệ khung hình</span> (nếu cần cắt theo tỷ lệ)
                        </td>
                      </tr>
                      <tr>
                        <td class="fw-semibold">3</td>
                        <td>Chọn thư mục lưu (tùy chọn)</td>
                        <td>
                          Trên Chrome/Edge, bạn có thể chọn thư mục để hệ thống lưu trực tiếp.
                          Các trình duyệt khác sẽ tải xuống như thông thường
                        </td>
                      </tr>
                      <tr>
                        <td class="fw-semibold">4</td>
                        <td>Thực hiện xử lý và lưu</td>
                        <td>
                          Nhấn <span class="fw-semibold">Thay đổi kích thước + Lưu</span> để xử lý hàng loạt
                          Theo dõi trạng thái tại bảng danh sách tệp và thanh tiến độ
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="small text-muted mt-2">
                  Lưu ý: Với ảnh chụp màn hình hoặc ảnh nhiều chữ, để đạt dung lượng nhỏ, bạn nên giảm <span
                    class="fw-semibold">Chiều rộng tối đa</span>.
                </div>
              </div>
            </div>

            <div class="row g-3 align-items-end">
              <div class="col-md-6">
                <label class="form-label">Chọn ảnh (hỗ trợ nhiều tệp)</label>

                <input id="fileInput" type="file" class="d-none" accept="image/*" multiple>

                <div class="input-group">
                  <input id="fileInputText" type="text" class="form-control" placeholder="Chọn ảnh..." readonly>
                  <button id="fileBrowseBtn" class="btn btn-outline-primary" type="button">Chọn</button>
                  <button id="clearFilesBtn" class="btn btn-outline-secondary" type="button" disabled>Xóa chọn</button>
                </div>

              </div>

              <div class="col-md-3">
                <label class="form-label">Dung lượng mục tiêu (KB)</label>
                <input id="targetKB" type="number" class="form-control" min="10" step="10" value="300">
              </div>

              <div class="col-md-3">
                <label class="form-label">Định dạng đầu ra</label>
                <select id="outFormat" class="form-select">
                  <option value="image/jpeg" selected>JPEG</option>
                  <option value="image/webp">WebP (nhẹ hơn, hiện đại)</option>
                </select>
              </div>

              <div class="col-md-3">
                <label class="form-label">Chiều rộng tối đa (px)</label>
                <input id="maxW" type="number" class="form-control" min="100" step="100" value="1200">
              </div>

              <div class="col-md-3">
                <label class="form-label">Chiều cao tối đa (px)</label>
                <input id="maxH" type="number" class="form-control" min="100" step="100" readonly placeholder="tự động">
              </div>

              <!-- Ratio controls -->
              <div class="col-md-3">
                <label class="form-label">Tỷ lệ khung hình</label>
                <select id="ratioSelect" class="form-select">
                  <option value="default" selected>Mặc định (giữ nguyên)</option>
                  <option value="1:1">1:1 (Vuông)</option>
                  <option value="4:3">4:3</option>
                  <option value="16:9">16:9</option>
                  <option value="3:4">3:4 (Dọc)</option>
                  <option value="4:5">4:5</option>
                  <option value="21:9">21:9 (Siêu rộng)</option>
                  <option value="custom">Tùy chỉnh...</option>
                </select>
              </div>

              <div class="col-md-3 d-flex gap-2">
                <div class="w-100">
                  <label class="form-label">Tùy chỉnh (Rộng)</label>
                  <input id="ratioW" type="number" class="form-control" min="1" step="1" value="16" disabled>
                </div>
                <div class="w-100">
                  <label class="form-label">Tùy chỉnh (Cao)</label>
                  <input id="ratioH" type="number" class="form-control" min="1" step="1" value="9" disabled>
                </div>
              </div>

              <div class="col-md-12 d-flex gap-2">
                <button id="pickFolderBtn" class="btn btn-outline-primary w-100" type="button">
                  1) Chọn thư mục lưu
                </button>
                <button id="startBtn" class="btn btn-primary w-100" type="button">
                  2) Thay đổi kích thước + Lưu
                </button>
              </div>
              <div class="col-md-12">
                <div id="pickedFolderInfo" class="small text-muted">
                  Chưa chọn thư mục lưu (sẽ tải xuống theo cơ chế thông thường).
                </div>
              </div>

            </div>

            <hr class="my-4">

            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-semibold">Danh sách tệp</div>
              <div class="text-muted small" id="capabilities"></div>
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th style="width:44px;">#</th>
                    <th>Tên tệp</th>
                    <th class="text-end">Dung lượng gốc</th>
                    <th class="text-end">Dung lượng sau xử lý</th>
                    <th class="text-end">Chất lượng</th>
                    <th>Trạng thái</th>
                  </tr>
                </thead>
                <tbody id="fileTableBody">
                  <tr>
                    <td colspan="6" class="text-muted">Chưa có tệp được chọn</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="mt-3">
              <div class="progress" role="progressbar" aria-label="Tiến độ">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
              </div>
              <div class="small text-muted mt-2" id="log"></div>
            </div>

          </div>
        </div>

        <div class="text-muted small mt-3">
          Gợi ý: Ảnh chụp (photo) phù hợp với JPEG/WebP. Với ảnh chụp màn hình hoặc ảnh nhiều chữ, bạn có thể cần giảm
          kích thước để đạt dung lượng thấp
        </div>

      </div>
    </div>
  </div>
  <footer>
    <div class=" container">
      <div class="text-center small text-muted footer-note">
        This gift is dedicated exclusively to <span class="fw-semibold">Vu Truc</span>.
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootbox@5.5.2/bootbox.min.js"></script>
  <script>
    function setPickedFolderUI(dirHandle) {
      if (!dirHandle) {
        $("#pickedFolderInfo").text("Chưa chọn thư mục lưu (sẽ tải xuống theo cơ chế thông thường).");
        return;
      }
      $("#pickedFolderInfo").text(`Thư mục đã chọn: ${dirHandle.name}`);
    }

    function bbAlert(message, title = "Thông báo") {
      return new Promise((resolve) => {
        bootbox.alert({
          title,
          message,
          centerVertical: true,
          backdrop: true,
          closeButton: false,
          callback: resolve
        });
      });
    }

    function bbConfirm(message, title = "Xác nhận") {
      return new Promise((resolve) => {
        bootbox.confirm({
          title,
          message,
          centerVertical: true,
          backdrop: true,
          closeButton: false,
          buttons: {
            confirm: { label: "Đồng ý", className: "btn-primary" },
            cancel: { label: "Hủy", className: "btn-outline-secondary" }
          },
          callback: (result) => resolve(!!result)
        });
      });
    }

    function updateFileInputText() {
      const count = selectedFiles?.length || 0;

      if (!count) {
        $("#fileInputText").val("").attr("placeholder", "Chọn ảnh...");
        $("#clearFilesBtn").prop("disabled", true);
        return;
      }

      $("#fileInputText").val(`${count} ảnh`);
      $("#clearFilesBtn").prop("disabled", false);
    }

    function formatBytes(bytes) {
      if (!Number.isFinite(bytes)) return "-";
      const kb = bytes / 1024;
      if (kb < 1024) return kb.toFixed(0) + " KB";
      return (kb / 1024).toFixed(2) + " MB";
    }

    function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

    function replaceExtension(filename, mime) {
      const dot = filename.lastIndexOf(".");
      const base = dot > 0 ? filename.slice(0, dot) : filename;
      const ext = (mime === "image/webp") ? ".webp" : ".jpg";
      return base + ext;
    }

    async function fileToImageBitmap(file) {
      return await createImageBitmap(file);
    }

    // -----------------------------
    // Hỗ trợ tỷ lệ khung hình
    // -----------------------------
    function parseRatioValue() {
      const v = $("#ratioSelect").val();
      if (!v || v === "default") return null;

      let rw, rh;
      if (v === "custom") {
        rw = Number($("#ratioW").val());
        rh = Number($("#ratioH").val());
      } else {
        const parts = v.split(":");
        rw = Number(parts[0]);
        rh = Number(parts[1]);
      }
      if (!Number.isFinite(rw) || !Number.isFinite(rh) || rw <= 0 || rh <= 0) return null;
      return { rw, rh, r: rw / rh }; // rộng/cao
    }

    function cropBitmapToRatio(bitmap, targetRatioWH) {
      const srcW = bitmap.width;
      const srcH = bitmap.height;
      const srcRatio = srcW / srcH;

      if (Math.abs(srcRatio - targetRatioWH) < 0.002) {
        return { sx: 0, sy: 0, sw: srcW, sh: srcH };
      }

      let sw, sh, sx, sy;

      if (srcRatio > targetRatioWH) {
        sh = srcH;
        sw = Math.round(srcH * targetRatioWH);
        sx = Math.round((srcW - sw) / 2);
        sy = 0;
      } else {
        sw = srcW;
        sh = Math.round(srcW / targetRatioWH);
        sx = 0;
        sy = Math.round((srcH - sh) / 2);
      }

      return { sx, sy, sw, sh };
    }

    function drawToCanvas(bitmap, maxW, maxH, ratioWH /* có thể null */) {
      const srcW = bitmap.width;
      const srcH = bitmap.height;

      let sx = 0, sy = 0, sw = srcW, sh = srcH;

      if (ratioWH) {
        const crop = cropBitmapToRatio(bitmap, ratioWH);
        sx = crop.sx; sy = crop.sy; sw = crop.sw; sh = crop.sh;
      }

      const scale = Math.min(1, maxW / sw, maxH / sh);
      const dstW = Math.max(1, Math.round(sw * scale));
      const dstH = Math.max(1, Math.round(sh * scale));

      const canvas = document.createElement("canvas");
      canvas.width = dstW;
      canvas.height = dstH;

      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";
      ctx.drawImage(bitmap, sx, sy, sw, sh, 0, 0, dstW, dstH);

      return canvas;
    }

    function canvasToBlob(canvas, mime, quality) {
      return new Promise((resolve) => {
        canvas.toBlob((blob) => resolve(blob), mime, quality);
      });
    }

    async function compressToTarget(canvas, mime, targetBytes) {
      let best = null;

      for (let dimAttempt = 0; dimAttempt < 6; dimAttempt++) {
        let low = 0.05, high = 0.95;
        let bestThisRound = null;

        for (let i = 0; i < 10; i++) {
          const q = (low + high) / 2;
          const blob = await canvasToBlob(canvas, mime, q);
          if (!blob) break;

          const size = blob.size;

          if (!bestThisRound || Math.abs(size - targetBytes) < Math.abs(bestThisRound.blob.size - targetBytes)) {
            bestThisRound = { blob, quality: q };
          }

          if (size > targetBytes) high = q;
          else low = q;
        }

        if (bestThisRound) {
          const candidate = bestThisRound;
          if (!best) {
            best = candidate;
          } else {
            const bestOk = best.blob.size <= targetBytes;
            const candOk = candidate.blob.size <= targetBytes;

            if (candOk && !bestOk) best = candidate;
            else if (candOk && bestOk && candidate.blob.size > best.blob.size) best = candidate;
            else if (!candOk && !bestOk && Math.abs(candidate.blob.size - targetBytes) < Math.abs(best.blob.size - targetBytes)) best = candidate;
          }

          if (Math.abs(candidate.blob.size - targetBytes) / targetBytes < 0.03) {
            return candidate;
          }

          if (candidate.blob.size <= targetBytes) {
            return candidate;
          }
        }

        const newW = Math.max(320, Math.round(canvas.width * 0.85));
        const newH = Math.max(320, Math.round(canvas.height * 0.85));
        if (newW === canvas.width && newH === canvas.height) break;

        const tmp = document.createElement("canvas");
        tmp.width = newW;
        tmp.height = newH;
        const tctx = tmp.getContext("2d", { alpha: false });
        tctx.imageSmoothingEnabled = true;
        tctx.imageSmoothingQuality = "high";
        tctx.drawImage(canvas, 0, 0, newW, newH);
        canvas = tmp;
      }

      return best || { blob: await canvasToBlob(canvas, mime, 0.6), quality: 0.6 };
    }

    function triggerDownload(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    async function writeToDirectory(dirHandle, blob, filename) {
      const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
    }

    // -----------------------------
    // Trạng thái giao diện
    // -----------------------------
    let pickedDirHandle = null;
    let selectedFiles = [];

    function setLog(msg) { $("#log").text(msg); }
    function setProgress(pct) { $("#progressBar").css("width", pct + "%").attr("aria-valuenow", pct); }

    function renderTable(files) {
      const $body = $("#fileTableBody");
      $body.empty();

      if (!files || files.length === 0) {
        $body.append(`<tr><td colspan="6" class="text-muted">Chưa có tệp được chọn</td></tr>`);
        return;
      }

      files.forEach((f, idx) => {
        const row = `
          <tr data-idx="${idx}">
            <td>${idx + 1}</td>
            <td class="text-truncate" style="max-width:380px;" title="${f.name}">${f.name}</td>
            <td class="text-end orig">${formatBytes(f.size)}</td>
            <td class="text-end res">-</td>
            <td class="text-end q">-</td>
            <td class="status text-muted">Chờ xử lý</td>
          </tr>
        `;
        $body.append(row);
      });
    }

    function updateRow(idx, patch) {
      const $row = $(`#fileTableBody tr[data-idx="${idx}"]`);
      if (!$row.length) return;
      if (patch.resultBytes != null) $row.find(".res").text(formatBytes(patch.resultBytes));
      if (patch.quality != null) $row.find(".q").text((patch.quality).toFixed(2));
      if (patch.status != null) $row.find(".status").text(patch.status).removeClass("text-muted").addClass(patch.statusClass || "");
      if (patch.statusClass) $row.find(".status").addClass(patch.statusClass);
    }

    function showCapabilities() {
      const canFS = !!window.showDirectoryPicker;
      $("#capabilities").text(
        canFS ? "Lưu theo thư mục: Hỗ trợ (Chrome/Edge)" : "Lưu theo thư mục: Không hỗ trợ (tải xuống theo cơ chế thông thường)"
      );
    }

    function clearSelectedFiles() {
      selectedFiles = [];

      // reset file input (quan trọng: chọn lại cùng file vẫn trigger change)
      const $file = $("#fileInput");
      $file.val("");

      // reset UI
      renderTable(selectedFiles);
      updateFileInputText();
      setProgress(0);
      setLog("");
    }

    // -----------------------------
    // Sự kiện
    // -----------------------------
    $(function () {
      showCapabilities();
      setPickedFolderUI(pickedDirHandle);

      // Đồng bộ chiều cao tối đa theo tỷ lệ / chiều rộng tối đa
      function updateMaxHFromRatio() {
        const maxW = clamp(Number($("#maxW").val()) || 1920, 100, 20000);
        const ratio = parseRatioValue();

        if (!ratio) {
          $("#maxH").val("");
          $("#maxH").attr("placeholder", "tự động");
          return;
        }

        $("#maxH").removeAttr("placeholder");
        const maxH = Math.round(maxW * (ratio.rh / ratio.rw));
        $("#maxH").val(maxH);
      }

      $("#ratioSelect").on("change", function () {
        const v = $(this).val();
        const isCustom = (v === "custom");
        $("#ratioW").prop("disabled", !isCustom);
        $("#ratioH").prop("disabled", !isCustom);
        updateMaxHFromRatio();
      });

      $("#ratioW, #ratioH, #maxW").on("input", function () {
        updateMaxHFromRatio();
      });

      updateMaxHFromRatio();

      $("#fileInput").on("change", function () {
        selectedFiles = Array.from(this.files || []);
        renderTable(selectedFiles);
        setLog(selectedFiles.length ? `Đã chọn ${selectedFiles.length} tệp.` : "");
        setProgress(0);
      });

      $("#pickFolderBtn").on("click", async function () {
        try {
          if (!window.showDirectoryPicker) {
            await bbAlert("Trình duyệt hiện tại không hỗ trợ chọn thư mục. Vui lòng sử dụng Chrome hoặc Edge để lưu vào thư mục đã chọn.");
            return;
          }
          pickedDirHandle = await window.showDirectoryPicker({ mode: "readwrite" });
          setPickedFolderUI(pickedDirHandle);
          await bbAlert(`Đã chọn thư mục lưu: <b>${pickedDirHandle.name}</b>. Vui lòng nhấn “Thay đổi kích thước + Lưu” để bắt đầu.`, "Thành công");
        } catch (e) {
          console.warn(e);
        }
      });

      $("#startBtn").on("click", async function () {
        if (!selectedFiles.length) {
          await bbAlert("Vui lòng chọn tệp hình ảnh trước khi thực hiện.");
          return;
        }

        const targetKB = Number($("#targetKB").val());
        const targetBytes = Math.max(10, targetKB) * 1024;

        const mime = $("#outFormat").val();
        const maxW = clamp(Number($("#maxW").val()) || 1920, 100, 20000);

        // maxH rỗng => không giới hạn
        const rawMaxH = $("#maxH").val();
        const maxH = rawMaxH === "" ? 20000 : clamp(Number(rawMaxH) || 20000, 100, 20000);

        const ratio = parseRatioValue();        // null nếu mặc định
        const ratioWH = ratio ? ratio.r : null; // rộng/cao

        setProgress(0);
        setLog("Đang xử lý...");

        if (pickedDirHandle) {
          try {
            const perm = await pickedDirHandle.queryPermission({ mode: "readwrite" });
            if (perm !== "granted") {
              const req = await pickedDirHandle.requestPermission({ mode: "readwrite" });
              if (req !== "granted") {
                pickedDirHandle = null;
                setPickedFolderUI(null);
                await bbAlert("Không được cấp quyền ghi vào thư mục đã chọn. Hệ thống sẽ chuyển sang tải xuống theo cơ chế thông thường.");
              }
            }
          } catch (e) {
            console.warn(e);
            pickedDirHandle = null;
            setPickedFolderUI(null);
          }
        }

        for (let i = 0; i < selectedFiles.length; i++) {
          const f = selectedFiles[i];
          updateRow(i, { status: "Đang xử lý...", statusClass: "text-primary" });

          try {
            const bitmap = await fileToImageBitmap(f);
            const canvas = drawToCanvas(bitmap, maxW, maxH, ratioWH);

            const result = await compressToTarget(canvas, mime, targetBytes);
            const outName = replaceExtension(f.name, mime);

            updateRow(i, {
              resultBytes: result.blob.size,
              quality: result.quality,
              status: pickedDirHandle ? "Đã lưu vào thư mục" : "Đã tải xuống",
              statusClass: "text-success"
            });

            if (pickedDirHandle) {
              await writeToDirectory(pickedDirHandle, result.blob, outName);
            } else {
              triggerDownload(result.blob, outName);
            }

          } catch (err) {
            console.error(err);
            updateRow(i, { status: "Thất bại", statusClass: "text-danger" });
          }

          setProgress(Math.round(((i + 1) / selectedFiles.length) * 100));
          setLog(`Đã xử lý ${i + 1}/${selectedFiles.length} tệp`);
        }

        setLog("Hoàn tất.");
      });

      // Click vào nút Chọn -> mở file picker
      $("#fileBrowseBtn").on("click", function () {
        $("#fileInput").trigger("click");
      });

      // Click vào ô text cũng mở picker
      $("#fileInputText").on("click", function () {
        $("#fileInput").trigger("click");
      });

      // Khi chọn file xong
      $("#fileInput").on("change", function () {
        selectedFiles = Array.from(this.files || []);
        renderTable(selectedFiles);
        updateFileInputText();

        setLog(selectedFiles.length ? `Đã chọn ${selectedFiles.length} ảnh.` : "");
        setProgress(0);
      });

      $("#clearFilesBtn").on("click", async function () {
        // nếu bạn đã có bbConfirm thì dùng confirm cho lịch sự
        const ok = await bbConfirm("Bạn có chắc chắn muốn xóa toàn bộ ảnh đã chọn không?", "Xác nhận");
        if (!ok) return;

        clearSelectedFiles();
      });
    })
  </script>
</body>

</html>